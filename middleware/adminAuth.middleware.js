// ================ middleware/adminAuth.middleware.js (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô) ================
import jwt from "jsonwebtoken";
import { AdminUser } from "../models/index.js";

/**
 * ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
 */
const decodeToken = async (token) => {
    try {
        console.log('üîç DECODING ADMIN TOKEN...');
        
        const decoded = jwt.verify(token, process.env.JWT_SECRET);
        const { user_id, _id, role, admin_role } = decoded;
        const adminId = user_id || _id;

        console.log('üîç DECODED TOKEN DATA:', { 
            adminId, 
            role, 
            admin_role,
            token_type: decoded.type 
        });

        // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏
        if (role !== "admin") {
            console.log('‚ùå INVALID ROLE:', role);
            return { 
                message: "Access denied! Invalid role!", 
                result: false, 
                status: 403 
            };
        }

        console.log('üîç SEARCHING FOR ADMIN:', { adminId, expected_role: admin_role });

        // ‚úÖ –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –ü—Ä—è–º–æ–π –ø–æ–∏—Å–∫ –≤ AdminUser –±–µ–∑ –ª–∏—à–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        const admin = await AdminUser.findById(adminId).select('-password_hash');

        if (!admin) {
            console.log('‚ùå ADMIN NOT FOUND:', adminId);
            return { 
                message: "Access denied! Admin not found!", 
                result: false, 
                status: 404 
            };
        }

        console.log('üîç ADMIN FOUND:', {
            admin_id: admin._id,
            email: admin.email,
            role: admin.role,
            is_active: admin.is_active,
            is_suspended: admin.suspension?.is_suspended
        });

        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º is_active –≤–º–µ—Å—Ç–æ account_status
        if (!admin.is_active) {
            console.log('‚ùå ADMIN ACCOUNT INACTIVE');
            return {
                message: "Access denied! Admin account is inactive!",
                result: false,
                status: 403
            };
        }

        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∏
        if (admin.suspension && admin.suspension.is_suspended) {
            const now = new Date();
            const suspendedUntil = admin.suspension.suspended_until;
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ –æ–Ω–∞ –ø—Ä–æ—à–ª–∞
            if (suspendedUntil && now > suspendedUntil) {
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–Ω–∏–º–∞–µ–º –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫—É
                admin.suspension.is_suspended = false;
                admin.suspension.suspended_until = undefined;
                await admin.save();
                console.log('‚úÖ AUTO-UNSUSPENDED ADMIN:', admin._id);
            } else {
                console.log('‚ùå ADMIN ACCOUNT SUSPENDED');
                return {
                    message: "Access denied! Admin account is suspended!",
                    result: false,
                    status: 403
                };
            }
        }

        // ‚úÖ –£–ü–†–û–©–ï–ù–ê: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ —Å–µ—Å—Å–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        const now = new Date();
        const lastActivity = admin.last_activity_at || admin.last_login_at;
        
        if (lastActivity) {
            const sessionTimeout = 8; // 8 —á–∞—Å–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const sessionExpiry = new Date(lastActivity.getTime() + (sessionTimeout * 60 * 60 * 1000));
            
            if (now > sessionExpiry) {
                console.log('‚è∞ SESSION EXPIRED for admin:', admin._id);
                return {
                    message: "Access denied! Session expired!",
                    result: false,
                    status: 401
                };
            }
        }

        // ‚úÖ –£–ü–†–û–©–ï–ù–û: –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è
        try {
            admin.last_activity_at = now;
            await admin.save();
        } catch (updateError) {
            console.warn('‚ö†Ô∏è Could not update admin activity:', updateError.message);
            // –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        }

        console.log('‚úÖ ADMIN ACCESS APPROVED:', {
            admin_id: admin._id,
            role: admin.role,
            is_active: admin.is_active
        });

        return { 
            message: "Access approved!", 
            result: true, 
            admin: admin,
            admin_role: admin_role || admin.role
        };

    } catch (err) {
        console.error('üö® TOKEN DECODE ERROR:', err);
        
        if (err.name === 'TokenExpiredError') {
            return { message: "Access denied! Token expired!", result: false, status: 401 };
        } else if (err.name === 'JsonWebTokenError') {
            return { message: "Access denied! Token invalid!", result: false, status: 401 };
        } else {
            return { message: "Access denied! Token error!", result: false, status: 401 };
        }
    }
};

/**
 * ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –±–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –∞–¥–º–∏–Ω–∞
 */
const checkAdminToken = async (req, res, next) => {
    try {
        console.log('üîç CHECK ADMIN TOKEN - START');
        
        const authHeader = req.headers["authorization"];
        const token = authHeader?.split(" ")[1];

        if (!token) {
            console.log('üö® NO TOKEN PROVIDED');
            return res.status(401).json({ 
                message: "Access denied! Token required!", 
                result: false 
            });
        }

        const data = await decodeToken(token);
        if (!data.result) {
            console.log('üö® TOKEN VALIDATION FAILED:', data.message);
            return res.status(data.status).json({
                message: data.message,
                result: false
            });
        }

        console.log('‚úÖ ADMIN TOKEN VERIFIED');
        req.admin = data.admin;
        req.admin_role = data.admin_role;

        next();

    } catch (error) {
        console.error('üö® CHECK ADMIN TOKEN ERROR:', error);
        res.status(500).json({ 
            message: "Access denied! Server error!", 
            result: false, 
            error: error.message 
        });
    }
};

/**
 * ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –ø–æ –≥—Ä—É–ø–ø–∞–º —Ä–æ–ª–µ–π
 */
const checkAccessByGroup = (requiredRoles) => {
    return async (req, res, next) => {
        try {
            console.log('üîç CHECK ACCESS BY GROUP:', { 
                required: requiredRoles,
                endpoint: req.path,
                method: req.method
            });
            
            const authHeader = req.headers["authorization"];
            const token = authHeader?.split(" ")[1];

            if (!token) {
                return res.status(401).json({ 
                    message: "Access denied! Token required!", 
                    result: false 
                });
            }

            const data = await decodeToken(token);
            if (!data.result) {
                return res.status(data.status).json({
                    message: data.message,
                    result: false
                });
            }

            const userRole = data.admin_role;

            console.log('üîç ROLE ACCESS CHECK:', {
                required_roles: requiredRoles,
                user_role: userRole,
                has_access: requiredRoles.includes(userRole)
            });

            // ‚úÖ –ü–†–û–í–ï–†–ö–ê —Ä–æ–ª–µ–π
            if (!requiredRoles.includes(userRole)) {
                // –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ø—ã—Ç–∫—É –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
                console.warn(`üö® UNAUTHORIZED ACCESS ATTEMPT:`, {
                    admin_id: data.admin._id,
                    admin_email: data.admin.email,
                    required_roles: requiredRoles,
                    actual_role: userRole,
                    endpoint: req.path,
                    method: req.method,
                    ip: req.ip,
                    timestamp: new Date()
                });

                return res.status(403).json({ 
                    message: `Access denied! Required roles: ${requiredRoles.join(', ')}. Your role: ${userRole}`, 
                    result: false,
                    security_info: {
                        required_permissions: requiredRoles,
                        current_role: userRole,
                        upgrade_needed: true
                    }
                });
            }

            console.log('‚úÖ ACCESS GRANTED:', {
                admin_role: userRole,
                endpoint: req.path
            });

            req.admin = data.admin;
            req.admin_role = data.admin_role;

            next();

        } catch (error) {
            console.error('üö® ACCESS CHECK ERROR:', error);
            res.status(500).json({ 
                message: "Access denied! Server error!", 
                result: false, 
                error: error.message 
            });
        }
    };
};

/**
 * ‚úÖ –ù–û–í–´–ô: –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è debugging
 */
const debugAdminAuth = async (req, res, next) => {
    try {
        const authHeader = req.headers["authorization"];
        const token = authHeader?.split(" ")[1];
        
        console.log('üêõ DEBUG ADMIN AUTH:', {
            has_auth_header: !!authHeader,
            has_token: !!token,
            token_length: token ? token.length : 0,
            token_preview: token ? token.substring(0, 20) + '...' : 'none'
        });

        if (token) {
            try {
                const decoded = jwt.verify(token, process.env.JWT_SECRET);
                console.log('üêõ DECODED TOKEN:', {
                    user_id: decoded.user_id || decoded._id,
                    role: decoded.role,
                    admin_role: decoded.admin_role,
                    exp: new Date(decoded.exp * 1000)
                });
                
                const admin = await AdminUser.findById(decoded.user_id || decoded._id);
                console.log('üêõ ADMIN FROM DB:', {
                    found: !!admin,
                    id: admin?._id,
                    email: admin?.email,
                    role: admin?.role,
                    is_active: admin?.is_active,
                    suspended: admin?.suspension?.is_suspended
                });
            } catch (debugError) {
                console.log('üêõ TOKEN DECODE ERROR:', debugError.message);
            }
        }

        next();
    } catch (error) {
        console.error('üêõ DEBUG ERROR:', error);
        next();
    }
};

export { 
    checkAdminToken, 
    checkAccessByGroup,
    debugAdminAuth // üÜï –î–ª—è debugging
};