// services/courier.service.js
import { User, CourierApplication, CourierProfile, Meta } from '../models/index.js';
import { cryptoString, decryptString } from '../utils/crypto.js';
import { hashString, hashMeta, comparePassword } from '../utils/hash.js';
import generatePassword from '../utils/generatePassword.js';
import mongoose from 'mongoose';

/**
 * –≠–¢–ê–ü 1: –°–û–ó–î–ê–ù–ò–ï –ó–ê–Ø–í–ö–ò –ö–£–†–¨–ï–†–ê
 * –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫—É—Ä—å–µ—Ä–∞ —Å –ø–æ–¥–∞—á–µ–π –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
 */
const createCourierApplication = async (applicationData) => {
  try {
    const {
      // –õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      first_name, last_name, email, phone, password, date_of_birth,
      street, city, postal_code,
      // –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç
      vehicle_type, vehicle_brand, vehicle_model, license_plate,
      insurance_company, insurance_policy_number,
      // –î–æ–∫—É–º–µ–Ω—Ç—ã URLs
      id_card_url, driver_license_url, insurance_url, 
      vehicle_registration_url, bank_rib_url,
      // –°–æ–≥–ª–∞—Å–∏—è
      terms_accepted, privacy_policy_accepted, 
      data_processing_accepted, background_check_accepted,
      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ
      referral_code, source = 'web'
    } = applicationData;

    // ================ –í–ê–õ–ò–î–ê–¶–ò–Ø ================

    // –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
    const requiredFields = {
      first_name, last_name, email, phone, date_of_birth,
      street, city, postal_code, vehicle_type,
      id_card_url, bank_rib_url,
      terms_accepted, privacy_policy_accepted, 
      data_processing_accepted, background_check_accepted
    };

    const missingFields = Object.entries(requiredFields)
      .filter(([key, value]) => !value)
      .map(([key]) => key);

    if (missingFields.length > 0) {
      throw new Error(`–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: ${missingFields.join(', ')}`);
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≥–ª–∞—Å–∏–π
    if (!terms_accepted || !privacy_policy_accepted || !data_processing_accepted || !background_check_accepted) {
      throw new Error('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–Ω—è—Ç—å –≤—Å–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è');
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    if (['motorbike', 'car'].includes(vehicle_type)) {
      if (!driver_license_url || !insurance_url) {
        throw new Error('–î–ª—è –º–æ—Ç–æ—Ü–∏–∫–ª–∞/–∞–≤—Ç–æ —Ç—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∏ —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞');
      }
      if (vehicle_type === 'car' && !vehicle_registration_url) {
        throw new Error('–î–ª—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¢–°');
      }
    }

    // ================ –ü–†–û–í–ï–†–ö–ê –î–£–ë–õ–ò–ö–ê–¢–û–í ================

    const normalizedEmail = email.toLowerCase().trim();
    const cleanPhone = phone.replace(/\s/g, '');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ Meta
    const hashedEmail = hashMeta(normalizedEmail);
    const existingMeta = await Meta.findOne({ em: hashedEmail });

    if (existingMeta) {
      throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞—è–≤–∫–∏ –∫—É—Ä—å–µ—Ä–æ–≤
    const existingApplication = await CourierApplication.findOne({
      $or: [
        { 'personal_data.phone': cleanPhone },
        { 'personal_data.email': normalizedEmail }
      ],
      status: { $in: ['pending', 'approved'] }
    });

    if (existingApplication) {
      throw new Error('–ó–∞—è–≤–∫–∞ –∫—É—Ä—å–µ—Ä–∞ —Å —Ç–∞–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ —É–∂–µ –ø–æ–¥–∞–Ω–∞');
    }

    // ================ –°–û–ó–î–ê–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ================

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–∞—Ä–æ–ª—å –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω
    const finalPassword = password || generatePassword();
    const hashedPassword = await hashString(finalPassword);

    // –°–æ–∑–¥–∞–µ–º User (—Å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–º email –∫–∞–∫ —É –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤)
    const newUser = new User({
      email: cryptoString(normalizedEmail), // üîê –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π email
      password_hash: hashedPassword,
      role: 'courier',
      is_active: true,
      is_email_verified: false,
      gdpr_consent: {
        data_processing: data_processing_accepted,
        marketing: false,
        analytics: false,
        consent_date: new Date()
      },
      registration_source: source || 'web'
    });

    await newUser.save();

    // –°–æ–∑–¥–∞–µ–º Meta –¥–ª—è –ø–æ–∏—Å–∫–∞
    const metaInfo = new Meta({
      em: hashedEmail, // üîê –•–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π email –¥–ª—è –ø–æ–∏—Å–∫–∞
      ui: newUser._id,
      ro: 'courier'
    });

    await metaInfo.save();

    // ================ –°–û–ó–î–ê–ù–ò–ï –ó–ê–Ø–í–ö–ò –ö–£–†–¨–ï–†–ê ================

    const courierApplication = new CourierApplication({
      user_id: newUser._id,
      
      // –õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      personal_data: {
        first_name: first_name.trim(),
        last_name: last_name.trim(),
        email: normalizedEmail, // –í –∑–∞—è–≤–∫–µ —Ö—Ä–∞–Ω–∏–º –æ—Ç–∫—Ä—ã—Ç–æ –¥–ª—è –∞–¥–º–∏–Ω–∞
        phone: cleanPhone,
        date_of_birth: new Date(date_of_birth),
        address: {
          street: street.trim(),
          city: city.trim(),
          postal_code: postal_code.trim(),
          country: 'France'
        }
      },

      // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ
      vehicle_info: {
        vehicle_type,
        vehicle_brand: vehicle_brand?.trim(),
        vehicle_model: vehicle_model?.trim(),
        license_plate: license_plate?.trim()?.toUpperCase(),
        insurance_company: insurance_company?.trim(),
        insurance_policy_number: insurance_policy_number?.trim()
      },

      // –î–æ–∫—É–º–µ–Ω—Ç—ã
      documents: {
        id_card_url, // –í—Å–µ–≥–¥–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
        driver_license_url: ['motorbike', 'car'].includes(vehicle_type) ? driver_license_url : undefined,
        insurance_url: ['motorbike', 'car'].includes(vehicle_type) ? insurance_url : undefined,
        vehicle_registration_url: vehicle_type === 'car' ? vehicle_registration_url : undefined,
        bank_rib_url // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –≤—ã–ø–ª–∞—Ç
      },

      // –°–æ–≥–ª–∞—Å–∏—è
      consents: {
        terms_accepted,
        privacy_policy_accepted,
        data_processing_accepted,
        background_check_accepted
      },

      // –°—Ç–∞—Ç—É—Å –∏ –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è
      status: 'pending',
      submitted_at: new Date(),
      review_info: {
        review_stage: 'documents',
        priority_level: 'normal'
      },

      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      source,
      referral_code: referral_code?.trim(),
      ip_address: applicationData.ip_address,
      user_agent: applicationData.user_agent
    });

    await courierApplication.save();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
    await courierApplication.checkForDuplicates();

    console.log('‚úÖ COURIER APPLICATION CREATED:', {
      application_id: courierApplication._id,
      user_id: newUser._id,
      email: normalizedEmail,
      status: 'pending'
    });

    return {
      success: true,
      user: {
        id: newUser._id,
        email: normalizedEmail,
        role: 'courier',
        is_active: true
      },
      application: {
        id: courierApplication._id,
        status: courierApplication.status,
        submitted_at: courierApplication.submitted_at,
        vehicle_type: courierApplication.vehicle_info.vehicle_type
      },
      credentials: {
        email: normalizedEmail,
        password: finalPassword // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–∞—Ä–æ–ª—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
      }
    };

  } catch (error) {
    console.error('üö® CREATE COURIER APPLICATION - Error:', error);
    throw error;
  }
};

/**
 * –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –ö–£–†–¨–ï–†–ê
 */
const loginCourier = async ({ email, password }) => {
  try {
    if (!email || !password) {
      throw new Error('Email –∏ –ø–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã');
    }

    const normalizedEmail = email.toLowerCase().trim();
    const hashedEmail = hashMeta(normalizedEmail);

    // –ü–æ–∏—Å–∫ —á–µ—Ä–µ–∑ Meta
    const metaRecord = await Meta.findByEmailAndRole(hashedEmail, 'courier');
    if (!metaRecord) {
      throw new Error('–ö—É—Ä—å–µ—Ä —Å —Ç–∞–∫–∏–º email –Ω–µ –Ω–∞–π–¥–µ–Ω');
    }

    // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const user = await User.findById(metaRecord.ui);
    if (!user || !user.is_active) {
      throw new Error('–ê–∫–∫–∞—É–Ω—Ç –∫—É—Ä—å–µ—Ä–∞ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω');
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –∞–∫–∫–∞—É–Ω—Ç–∞
    if (user.isAccountLocked()) {
      throw new Error('–ê–∫–∫–∞—É–Ω—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∏–∑-–∑–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞');
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–æ–ª—å
    const isPasswordValid = await comparePassword(password, user.password_hash);
    if (!isPasswordValid) {
      await user.incrementLoginAttempts();
      throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
    }

    // –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
    await user.resetLoginAttempts();

    // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –∫—É—Ä—å–µ—Ä–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    const courierProfile = await CourierProfile.findOne({ user_id: user._id });

    return {
      success: true,
      user: {
        id: user._id,
        email: normalizedEmail,
        role: user.role,
        is_active: user.is_active,
        last_login_at: user.last_login_at
      },
      courier: courierProfile ? {
        id: courierProfile._id,
        first_name: courierProfile.first_name,
        last_name: courierProfile.last_name,
        is_approved: courierProfile.is_approved,
        is_available: courierProfile.is_available,
        application_status: courierProfile.application_status
      } : null
    };

  } catch (error) {
    console.error('üö® LOGIN COURIER - Error:', error);
    throw error;
  }
};

/**
 * –ü–û–õ–£–ß–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê –ó–ê–Ø–í–ö–ò –ö–£–†–¨–ï–†–ê
 */
const getCourierApplicationStatus = async (userId) => {
  try {
    const application = await CourierApplication.findOne({ user_id: userId });
    
    if (!application) {
      return {
        has_application: false,
        status: null
      };
    }

    return {
      has_application: true,
      application: {
        id: application._id,
        status: application.status,
        submitted_at: application.submitted_at,
        vehicle_type: application.vehicle_info.vehicle_type,
        verification_status: application.verification.overall_verification_status,
        review_notes: application.review_info.admin_notes
      }
    };

  } catch (error) {
    console.error('üö® GET APPLICATION STATUS - Error:', error);
    throw error;
  }
};

/**
 * –ü–û–õ–£–ß–ï–ù–ò–ï –ü–†–û–§–ò–õ–Ø –ö–£–†–¨–ï–†–ê
 */
const getCourierProfile = async (userId) => {
  try {
    const courierProfile = await CourierProfile.findOne({ user_id: userId });
    
    if (!courierProfile) {
      throw new Error('–ü—Ä–æ—Ñ–∏–ª—å –∫—É—Ä—å–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
    }

    return {
      success: true,
      profile: courierProfile
    };

  } catch (error) {
    console.error('üö® GET COURIER PROFILE - Error:', error);
    throw error;
  }
};

/**
 * –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê –î–û–°–¢–£–ü–ù–û–°–¢–ò (On-e/Off-e)
 */
const toggleCourierAvailability = async (userId) => {
  try {
    const courierProfile = await CourierProfile.findOne({ user_id: userId });
    
    if (!courierProfile) {
      throw new Error('–ü—Ä–æ—Ñ–∏–ª—å –∫—É—Ä—å–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
    }

    if (!courierProfile.is_approved) {
      throw new Error('–ö—É—Ä—å–µ—Ä –Ω–µ –æ–¥–æ–±—Ä–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã');
    }

    await courierProfile.toggleAvailability();

    return {
      success: true,
      is_available: courierProfile.is_available,
      is_online: courierProfile.is_online
    };

  } catch (error) {
    console.error('üö® TOGGLE AVAILABILITY - Error:', error);
    throw error;
  }
};

/**
 * –û–ë–ù–û–í–õ–ï–ù–ò–ï –ì–ï–û–õ–û–ö–ê–¶–ò–ò –ö–£–†–¨–ï–†–ê
 */
const updateCourierLocation = async (userId, { latitude, longitude }) => {
  try {
    const courierProfile = await CourierProfile.findOne({ user_id: userId });
    
    if (!courierProfile) {
      throw new Error('–ü—Ä–æ—Ñ–∏–ª—å –∫—É—Ä—å–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
    }

    await courierProfile.updateLocation(latitude, longitude);

    return {
      success: true,
      location: courierProfile.location
    };

  } catch (error) {
    console.error('üö® UPDATE LOCATION - Error:', error);
    throw error;
  }
};

export {
       createCourierApplication,
       loginCourier,
       getCourierApplicationStatus,
       getCourierProfile,
       toggleCourierAvailability,
       updateCourierLocation
      }